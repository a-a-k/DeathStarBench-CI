name: Social Network resilience demo

on:
  push:
  workflow_dispatch:
    inputs:
      threshold:
        description: 'Override the reliability gate threshold'
        required: false
      pfail_set:
        description: 'JSON array of failure priors to simulate (e.g. [0.1,0.3,0.5])'
        required: false
      endpoint_filters:
        description: 'Comma-separated endpoints to gate (empty = all)'
        required: false
      gate_mode:
        description: 'Gate mode: any (default) or mean'
        required: false

env:
  THRESHOLD: ${{ github.event.inputs.threshold || vars.SN_THRESHOLD || '0.95' }}
  PFAIL_SET: ${{ github.event.inputs.pfail_set || vars.SN_PFAIL_SET || '[0.1, 0.3, 0.5]' }}
  ENDPOINT_FILTERS: ${{ github.event.inputs.endpoint_filters || vars.SN_ENDPOINT_FILTERS || '' }}
  GATE_MODE: ${{ github.event.inputs.gate_mode || vars.SN_GATE_MODE || 'any' }}
  ARTIFACTS_DIR: socialNetwork/resilience-demo/artifacts
  OUTPUT_DIR: socialNetwork/resilience-demo/out
  SUMMARY_PATH: socialNetwork/resilience-demo/out/gate_summary.json
  REPORT_DIR: socialNetwork/resilience-demo/report
  REPORT_HTML: socialNetwork/resilience-demo/report/index.html

jobs:
  collect-dependencies:
    name: Capture live dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install wrk2 dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev zlib1g-dev libluajit-5.1-dev
          python3 -m pip install --upgrade pip
          python3 -m pip install aiohttp
      - name: Build wrk2 load generator
        run: make -C wrk2
      - name: Start Social Network stack
        working-directory: socialNetwork
        env:
          COMPOSE_DOCKER_CLI_BUILD: 1
          DOCKER_BUILDKIT: 1
        run: docker compose up -d
      - name: Warm services and snapshot dependencies
        env:
          WRK_BIN: ${{ github.workspace }}/wrk2/wrk
          DEPS_PATH: ${{ github.workspace }}/socialNetwork/resilience-demo/artifacts/deps.json
        run: |
          set -euo pipefail
          cd socialNetwork
          for attempt in {1..30}; do
            if curl -sf http://127.0.0.1:8080/index.html >/dev/null; then
              break
            fi
            sleep 5
          done
          if ! curl -sf http://127.0.0.1:8080/index.html >/dev/null; then
            echo "Social Network frontend did not become ready" >&2
            exit 1
          fi
          python3 scripts/init_social_graph.py --graph socfb-Reed98 --compose --ip 127.0.0.1 --port 8080
          "${WRK_BIN}" -t2 -c32 -d30s -R300 \
            -s wrk2/scripts/social-network/mixed-workload.lua \
            http://127.0.0.1:8080/index.html
          sleep 15
          ts=$(($(date +%s%N)/1000000))
          curl -sSf "http://127.0.0.1:16686/api/dependencies?endTs=$ts&lookback=3600000" >"${DEPS_PATH}"
      - name: Tear down Social Network stack
        if: always()
        working-directory: socialNetwork
        run: docker compose down
      - name: Upload dependencies snapshot
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: social-network-deps
          path: socialNetwork/resilience-demo/artifacts/deps.json

  simulate:
    name: Run simulations (pfail=${{ matrix.pfail }})
    needs: collect-dependencies
    strategy:
      matrix:
        pfail: ${{ fromJSON(github.event.inputs.pfail_set || vars.SN_PFAIL_SET || '[0.1, 0.3, 0.5]') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: socialNetwork/resilience-demo/requirements.txt
      - name: Install requirements
        run: pip install -r socialNetwork/resilience-demo/requirements.txt
      - name: Download dependencies snapshot
        uses: actions/download-artifact@v4
        with:
          name: social-network-deps
          path: ${{ runner.temp }}/social-network-deps
      - name: Prepare dependency graph
        run: |
          set -euo pipefail
          mkdir -p "$ARTIFACTS_DIR"
          snapshot="$(find "$RUNNER_TEMP/social-network-deps" -name 'deps.json' -print -quit)"
          if [ -z "$snapshot" ]; then
            echo "No deps.json found in artifact" >&2
            exit 1
          fi
          cp "$snapshot" "$ARTIFACTS_DIR/deps.json"
      - name: Run resilience simulation
        env:
          PFAIL: ${{ matrix.pfail }}
        run: |
          mkdir -p "$OUTPUT_DIR"
          python socialNetwork/resilience-demo/simulate.py --graph "$ARTIFACTS_DIR/deps.json" --replicas "$ARTIFACTS_DIR/norepl.yaml" --pfail "$PFAIL" --out "$OUTPUT_DIR/norepl_pfail-$PFAIL.json"
          python socialNetwork/resilience-demo/simulate.py --graph "$ARTIFACTS_DIR/deps.json" --replicas "$ARTIFACTS_DIR/replicas.yaml" --pfail "$PFAIL" --out "$OUTPUT_DIR/repl_pfail-$PFAIL.json"
      - name: Upload simulation outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: social-network-resilience-${{ matrix.pfail }}
          path: |
            ${{ env.OUTPUT_DIR }}/norepl_pfail-${{ matrix.pfail }}.json
            ${{ env.OUTPUT_DIR }}/repl_pfail-${{ matrix.pfail }}.json

  gate-and-report:
    name: Gate and publish report
    needs: simulate
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      gate_passed: ${{ steps.gate.outputs.passed }}
      gate_reason: ${{ steps.gate.outputs.reason }}
      gate_summary_path: ${{ steps.gate.outputs.summary_path }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: socialNetwork/resilience-demo/requirements.txt
      - name: Install requirements
        run: pip install -r socialNetwork/resilience-demo/requirements.txt
      - name: Download simulation outputs
        uses: actions/download-artifact@v4
        with:
          pattern: social-network-resilience-*
          merge-multiple: true
          path: ${{ env.OUTPUT_DIR }}
      - name: Apply release gate
        id: gate
        continue-on-error: true
        run: |
          set -o pipefail
          gate_output="$(python socialNetwork/resilience-demo/gate.py --results "$OUTPUT_DIR" --threshold "$THRESHOLD" --mode "$GATE_MODE" --filters "$ENDPOINT_FILTERS" --summary "$SUMMARY_PATH" 2>&1)"
          status=$?
          echo "$gate_output"
          if [ -f "$SUMMARY_PATH" ]; then
            echo "summary_path=$SUMMARY_PATH" >>"$GITHUB_OUTPUT"
            passed=$(jq -r '.passed' "$SUMMARY_PATH")
            reason=$(jq -r '.reason' "$SUMMARY_PATH")
            echo "passed=$passed" >>"$GITHUB_OUTPUT"
            echo "reason<<'EOF'" >>"$GITHUB_OUTPUT"
            echo "$reason" >>"$GITHUB_OUTPUT"
            echo "EOF" >>"$GITHUB_OUTPUT"
          else
            echo "passed=false" >>"$GITHUB_OUTPUT"
            echo "reason<<'EOF'" >>"$GITHUB_OUTPUT"
            echo "$gate_output" >>"$GITHUB_OUTPUT"
            echo "EOF" >>"$GITHUB_OUTPUT"
          fi
          exit $status
      - name: Build static HTML report
        if: always()
        run: |
          python socialNetwork/resilience-demo/report.py --results "$OUTPUT_DIR" --summary "$SUMMARY_PATH" --html "$REPORT_HTML"
      - name: Add gate summary to job summary
        if: always()
        run: |
          if [ -f "$SUMMARY_PATH" ]; then
            {
              echo "## Release gate results"
              echo
              echo "Threshold: $THRESHOLD"
              echo
              echo '```json'
              cat "$SUMMARY_PATH"
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v4
        with:
          path: ${{ env.REPORT_DIR }}

  deploy:
    name: Deploy GitHub Pages
    needs: gate-and-report
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'github-pages' || format('github-pages-preview/{0}', github.ref_name) }}
      url: ${{ steps.deploy.outputs.page_url || steps.deploy.outputs.preview_url || '' }}
    steps:
      - name: Summarize gate outcome
        run: |
          echo "Gate passed: ${{ needs.gate-and-report.outputs.gate_passed }}"
          echo "Gate reason: ${{ needs.gate-and-report.outputs.gate_reason }}"
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
        with:
          preview: ${{ github.ref != 'refs/heads/main' }}

  enforce-gate:
    name: Propagate gate failure
    needs:
      - gate-and-report
      - deploy
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Fail when the gate fails
        run: |
          if [ "${{ needs.gate-and-report.outputs.gate_passed }}" != "true" ]; then
            echo "Release gate failed: ${{ needs.gate-and-report.outputs.gate_reason }}"
            exit 1
          fi
          echo "Release gate passed"
